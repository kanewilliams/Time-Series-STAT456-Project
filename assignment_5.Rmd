---
title: "Assignment 5 - Decomposing New Zealand Electrical Demand using stl() and str()"
author: "Kane Williams (pkw21@uclive.ac.nz)"
output:
  pdf_document:
    toc: true
  html_document:
    toc: true
    toc_float: true
    highlight: tango
    theme: flatly
header-includes: \usepackage{amsmath}
subtitle: "STAT456-24S2 - Time Series and Stochastic Processes"
editor_options:
  markdown:
    wrap: 72
---

<!-- <style> -->

<!-- .boxTask { -->
<!-- background-color: lightblue; -->
<!-- color: black; -->
<!-- border: 2px solid black; -->
<!-- margin: 5px; -->
<!-- padding: 5px; -->
<!-- font-style: italic; -->
<!-- } -->

<!-- /* Centered headings */ -->
<!-- h1, h2, h3, h4, h5, h6 { -->
<!--   text-align: center; -->
<!-- } -->

<!-- </style> -->



<!-- <style> -->

<!-- .boxTask { -->
<!-- background-color: lightblue; -->
<!-- color: black; -->
<!-- border: 2px solid black; -->
<!-- margin: 5px; -->
<!-- padding: 5px; -->
<!-- font-style: italic; -->
<!-- } -->

<!-- /* Centered headings */ -->
<!-- h1, h2, h3, h4, h5, h6 { -->
<!--   text-align: center; -->
<!-- } -->

<!-- </style> -->

# Introduction

In this assignment/project, an 8-week period of New Zealand's historical electricity demand will be
decomposed using two different methods, `stl()` and the newer `str()`.

The resulting decompositions will be compared (i) visually, (ii) through an analysis of the residuals, and (iii) through their ability to forecast.
  
It will be discovered that *bla bla bla TODO*.

## Electricity Demand in New Zealand

New Zealand's electrical demand (two thirds of which are from households and industry (MBIE, 2024)) is influenced by factors such as temperature, weekends, holidays, and the day of the year. There are at least daily, weekly, and yearly seasonal components in New Zealand's electrical demand. Understanding the effects that each of these seasonal components contributes to overall demand requires the use of time series decomposition.

## Decomposition Techniques

### `stl()`

`stl()` is an R function that decomposes time series into three components: trend, seasonal, and remainder. It is based on the work of Cleveland (1990) and works by using LOESS (Locally Estimated Scatterplot Smoothing) to iteratively refine estimates of each component. The method was designed to be (i) simple to use, (ii) fast to compute, and (iii) allow for specifying seasonal/trend smoothing in a continuous way. It was designed for only a single seasonal component, although it can be adapted for multiple seasonalities through nested applications. It is only designed for *additive* decomposition.


### `str()`

`str()` is an R function developed by Dokumentov and Hyndman (2021) that decomposes time series into multiple seasonal components. It is based on a regularized optimization, and is related to ridge regression. It attempts to address limitations in other methods by allowing for not only multiple seasonal patterns, but also (i) non-integer periods, (ii) interactions between the components, (iii) complex topologies such as modelling holidays, and even (iv) covariates such as temperature and the presense of COVID-19. Furthermore, as it is based on a statistical model, confidence intervals can be computed. It is designed for both *additive* and *multiplicative* decomposition.

For a more technical description of both of the above methods - in the author's own words - please see the appendix.

# Data

## Data Description

The dataset chosen was: **Demand trends**.

-   It was pulled on `1 October 2024` from the [Electricity
    Authority](https://www.emi.ea.govt.nz/Wholesale/Reports/W_GD_C?DateFrom=20190901&DateTo=20240831&RegionType=NZ&_rsdr=L60M&_si=_dr_DateFrom%7C20140101,_dr_DateTo%7C20231231,_dr_RegionType%7CNZ,_dr__rsdr%7CL10Y,v%7C4)
    with the following parameters:
    -   **Date Range**: 01 Jan 2014 - 31 Dec 2023
    -   **Region Type**: New Zealand
    -   **Time Scale** Trading Period (i.e. half-hourly data)

Note that the unit of measurement is GWh (Gigawatt hours).

This data will then be reduced to the 10 weeks beginning from `5 December 2022`. This date was chosen because it (i) includes the Christmas period, which will be a good test for how each technique deals with "Holiday" effects, and (ii) conveniently begins on a Monday, which may make the plots easier to interpret. 

10 weeks was chosen because it is small enough that it is easy to visually identify both weekly and daily periods, and it is large enough to exhibit multiple-seasonality from both of these periods. Later on, a larger period will be chosen so that the the effect of yearly seasonality on the models can be investigated.

## Data Import

```{r echo=FALSE}
source("./src/packages.R")
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 80), tidy = TRUE)
```

First the data will be read in. Afterwards, it will be filtered for relevant dates/columns. 

```{r echo=FALSE}
# READ DATA
file_path <- "./data/NZ_Electricity_Demand_2014-2023.csv"
header <- c("Period_Start", "Period_End", "Region_ID", "Region", "Price")

raw_data <- read_csv(file_path, 
                     skip = 12, 
                     col_names = header,
                     show_col_types = FALSE) %>%
  mutate(
    Price = as.numeric(Price),
    Period_Start = dmy_hms(Period_Start),
    Period_End = dmy_hms(Period_End)
  )
```


```{r echo=FALSE}
# FILTER DATA (for ease of use)
elec_data <- raw_data %>%
  # Select relevant columns
  dplyr::select(Period_Start, Price) %>%
  # Filter for 4 weeks starting from Monday, Feb 13, 2023
  dplyr::filter(Period_Start >= as.Date("2022-12-05") & 
                Period_Start < as.Date("2022-12-05") + weeks(10))

head(elec_data, 3)
```

## Plot

```{r echo=FALSE}
ggplot(elec_data, aes(x = Period_Start, y = Price)) +
  geom_line() +
  geom_vline(xintercept = as.POSIXct("2022-12-25"), color = "red", linetype = "dashed", linewidth = 1) +
  annotate("text", x = as.POSIXct("2022-12-25"), y = max(elec_data$Price), 
           label = "Christmas", color = "red", vjust = 2, hjust = -0.1) +
  # geom_vline(xintercept = as.POSIXct("2023-02-07"), color = "blue", linetype = "dashed", size = 0.5) +
  # annotate("text", x = as.POSIXct("2023-02-07"), y = max(elec_data$Price), 
  #          label = "Waitangi Public Holiday", color = "blue", vjust = 2, hjust = -0.1) +
  labs(
    title = "New Zealand Electrical Demand",
    subtitle = "10 weeks from December 5, 2022",
    #x = "Date",
    y = "Electricity Demand (GWh)"
  ) +
  xlab("") + # no x label
  theme(
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  ) +
  scale_x_datetime(date_breaks = "1 week", date_labels = "%b %d")
```
**Immediate observations**

There are clear weekly and daily seasonality present. A decrease in electricity demand leading up to the dip during the Christmas and New Years period is very noticeable. After that, there is a slow rising trend. There may have been a New Years' effect. Another New Zealand public holiday Waitangi day, was observed on the 7th of February 2022, but there does not appear to be any noticeable effect from it. Schools began opening from the 31st of January, and there does not seem to be any noticeable effect from this either, although it may just not be clear for this particular timeframe.

## Fitting `ts` and `msts` 

The data will now be converted to a `ts` (time series) object for `stl()`, and an `msts` (multi-seasonal time series) object for `str()`.

```{r echo=FALSE}
season_day <- 48 # day
season_week <- 48 * 7 # week
season_year <- 48 * 7 * 52.25 # year

# CREATE ts OBJECT (for stl)
# Only one seasonality allowed - Just Weekly chosen
elec_ts <- ts(elec_data$Price,
                     frequency = season_week 
)
# CREATE msts OBJECT (for str) - All seasonalities
elec_msts_all <- forecast::msts(as.vector(elec_data$Price), 
                             seasonal.periods = c(season_day, season_week, season_year)
)
# CREATE msts OBJECT (for str) - Just Weekly seasonality
elec_msts_week <- forecast::msts(as.vector(elec_data$Price), 
                             seasonal.periods = c(season_week, season_year)
)
```

```{r echo=FALSE}
head(elec_ts)
```

# Decomposition using stl()

```{r echo=FALSE}
elec_stl <- stl(elec_ts, s.window="periodic")

elec_stl %>% autoplot
```

For this time period, there was not much of any increasing/decreasing trend. `stl` picked up a "trend"
**TODO** Do I need to change any settings? e.g. t.window, s.window

# Decomposition using str()

```{r echo=FALSE}
elec_str <- AutoSTR(elec_msts_all, gapCV = 48, confidence = NULL)
```

```{r echo=FALSE}
plot(elec_str)
```

(*Note* Running `str()` definitely takes longer than `stl()`. Running time will be benchmarked in the appendix.)
The str() decomposition shows, from the top down:

-   An "observed trend" component.
-   A daily seasonal component.
-   A weekly seasonal component.
-   A random (i.e. residual) component.
-   A fit/forecast using the above seasonal and trend components.

It can be noticed that:

-   TODO, bla bla


# Comparison of stl and str

This will be done three ways:

1)  A visual inspection,
2)  By analysing the residuals and performing a ACF/PACF/e.t.c., and
    lastly
3)  YOUR CHOICE CLAUDE

### Visual Inspection

Bla bla

### Analysis of Residuals

First the PACF/ACF of the `stl` output will be plotted, followed by the PACF/ACF of `str`.

```{r}
# remainder_stl <- elec_stl$time.series[, "remainder"]
# pacf(remainder_stl)
# acf(remainder_stl)
```

```{r}
# remainder_str <- unlist(elec_str$output$random)
# pacf(remainder_str)
# acf(remainder_str)
```

The above plots show that 


### Short-term Forecasting

 TODO FORECAST 1 WEEK AHEAD USING STL AS WELL AS STR

# Conclusions

Overall, str() appears to perform the better fit.

## Practical Implications

`str()` appears to be better fit for the purpose, if the goal is to understand electricity demand. Out of the box it provides an easily readable plot of the seasonal components, and the confidence intervals are an added bonus. However, it is several orders of magnitude slower than `stl()` (see the appendix). If a quick and easy analysis is needed, it may be preferable to use `stl()`. 

## Possible Extensions

The above analysis could be extended by:

-   Performing an analysis over a holiday period such as Christmas, to
    see how it the seasonal components are affected by lower holiday
    demand.
-   Performing an analysis for long-term data, where yearly effects
    could be incorporated.
-   Incorporating a temperature component to the models.
-   Incorporating holidays as an additional 
-   *Detecting* undiscovered seasonal components.
-   Using the logged data for stl in case it has multiplicative components.

# Bibliography

<https://otexts.com/fpp2/complexseasonality.html>

<https://cran.r-project.org/web/packages/stR/vignettes/stRvignette.html>

Cleveland, R. B., Cleveland, W. S., McRae, J. E., & Terpenning, I. J. (1990). STL: A seasonal-trend decomposition procedure based on loess. Journal of Official Statistics, 6(1), 3â€“33. http://bit.ly/stl1990

<https://www.mbie.govt.nz/building-and-energy/energy-and-natural-resources/energy-statistics-and-modelling/energy-statistics/electricity-statistics>

# Appendix

## `stl()` technical details

stl works by ...

## `str()` technical details

`str` works by ...

## Time Comparison

```{r}
# library(microbenchmark)
# 
# # Ensure elec_ts and elec_msts are defined as before
# 
# benchmark_results <- microbenchmark(
#   stl = stl(elec_ts, s.window="periodic"),
#   str = AutoSTR(elec_msts, gapCV = 48, confidence = 0.95),
#   times = 10
# )
# 
# print(benchmark_results)
# 
# # Visualize the results
# library(ggplot2)
# autoplot(benchmark_results)
```


The above graph show that `stl()` is at least 3 orders of magnitude slower than `str()` on this dataset.

## An error running the Robust version

Running the 'Robust' version of stR by setting `robust=TRUE` caused R to either crash unexpectedly or return an error message.

Specifically, `AutoSTR(elec_msts_all, gapCV = 48, confidence = NULL, robust=TRUE)` will crash if the number of weeks is set to $10$, while it will return the following error message if weeks is set to $3$:

  as(<dgCMatrix>, "dgTMatrix")' is deprecated.
  Use 'as(., "TsparseMatrix")' instead.
  See help("Deprecated") and help("Matrix-deprecated").
  
*Note for future reference:*
  
  R is at the current (24/10/10) version: 4.4.1
  `stR` is at the current version: 0.7
